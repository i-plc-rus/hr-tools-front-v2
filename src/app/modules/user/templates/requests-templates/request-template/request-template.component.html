@if (isLoaded) {
    <form [formGroup]="form" class="max-w-[1100px] mb-[70px]">
        <mat-tab-group [selectedIndex]="selectedTabIndex" (selectedIndexChange)="onTabChange($event)" class="!bg-transparent">
            <mat-tab label="Условия найма">
                <div class="flex flex-col gap-6 py-4 overflow-y-auto pr-2">
                    <section>
                        <h2 class="text-3xl mb-4">Общая информация</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative overflow-visible">
                                <app-text-input type="text" formControlName="company_name" label="Название компании" class="w-full"></app-text-input>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <app-text-input type="text" formControlName="vacancy_name" label="Название вакансии*" class="w-full">
                                    @if (form.get("vacancy_name")?.invalid && !form.get("vacancy_name")?.untouched) {
                                        <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                            <mat-icon svgIcon="error"></mat-icon>
                                        </span>
                                    }
                                </app-text-input>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Структура</mat-label>
                                <mat-select [formControl]="form.controls['company_struct_id']">
                                    @for (item of companyStructureArray; track $index) {
                                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                                    }
                                </mat-select>
                                @if (form.get("company_struct_id")?.invalid && !form.get("company_struct_id")?.untouched) {
                                    <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                        <mat-icon svgIcon="error"></mat-icon>
                                    </span>
                                }
                                </mat-form-field>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Подразделение</mat-label>
                                <mat-select [formControl]="form.controls['department_id']">
                                    @for (item of companyDepartmentArray; track $index) {
                                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                                    }
                                </mat-select>
                                @if (form.get("department_id")?.invalid && !form.get("department_id")?.untouched) {
                                    <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                        <mat-icon svgIcon="error"></mat-icon>
                                    </span>
                                }
                                </mat-form-field>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Штатная должность</mat-label>
                                <mat-select [formControl]="form.controls['job_title_id']">
                                    @for (item of companyJobsNamesArray; track $index) {
                                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                                    }
                                </mat-select>
                                @if (form.get("job_title_id")?.invalid && !form.get("job_title_id")?.untouched) {
                                    <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                        <mat-icon svgIcon="error"></mat-icon>
                                    </span>
                                }
                                </mat-form-field>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2 class="text-3xl mb-4">Местоположение и контакты</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative overflow-visible">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Город</mat-label>
                                <input type="text" matInput [formControl]="form.controls['city_id']" [matAutocomplete]="auto" />
                                <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayCityName">
                                    @for (item of filteredCity$ | async; track item) {
                                        <mat-option [value]="item">{{ item.address }}</mat-option>
                                    }
                                </mat-autocomplete>
                                @if (form.get("city_id")?.invalid && !form.get("city_id")?.untouched) {
                                    <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                        <mat-icon svgIcon="error"></mat-icon>
                                    </span>
                                }
                                </mat-form-field>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <app-text-input type="text" formControlName="place_of_work" label="Адрес офиса" class="w-full"></app-text-input>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <app-text-input type="text" formControlName="chief_fio" label="ФИО непосредственного руководителя*" class="w-full">
                                    @if (form.get("chief_fio")?.invalid && !form.get("chief_fio")?.untouched) {
                                        <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                            <mat-icon svgIcon="error"></mat-icon>
                                        </span>
                                    }
                                </app-text-input>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2 class="text-3xl mb-4">Детали вакансии</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative overflow-visible">
                                <app-text-input type="number" formControlName="opened_positions" label="Количество вакантных позиций*" class="w-full">
                                @if (form.get("opened_positions")?.invalid && !form.get("opened_positions")?.untouched) {
                                    <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                        <mat-icon svgIcon="error"></mat-icon>
                                    </span>
                                }
                                </app-text-input>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Срочность</mat-label>
                                <mat-select [formControl]="form.controls['urgency']">
                                    @for (urgency of urgencys; track $index) {
                                        <mat-option [value]="urgency.value">{{ urgency.name }}</mat-option>
                                    }
                                </mat-select>
                                </mat-form-field>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                            <div class="relative overflow-visible">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Тип заявки</mat-label>
                                <mat-select [formControl]="form.controls['request_type']">
                                    @for (request_type of request_types; track $index) {
                                        <mat-option [value]="request_type.value">{{ request_type.name }}</mat-option>
                                    }
                                </mat-select>
                                </mat-form-field>
                                @if (formDisabled) {
                                    <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                                }
                            </div>
                        </div>
                    </section>
                </div>
            </mat-tab>

            <mat-tab label="Требования к соискателю">
                <div class="flex flex-col gap-4 py-4 overflow-y-auto pr-2">
                    <h2 class="text-3xl mb-4">Требования, обязанности, условия</h2>
                    <div class="relative overflow-visible">
                        <app-text-editor height="160px" formControlName="requirements"></app-text-editor>
                        @if (formDisabled) {
                            <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                        }
                    </div>
                    <label class="text-base font-medium mt-2">Условия</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative overflow-visible">
                            <mat-form-field appearance="outline" class="w-full">
                                <mat-label>Занятость</mat-label>
                            <mat-select [formControl]="form.controls['employment']">
                                @for (employment of employments; track $index) {
                                    <mat-option [value]="employment.value">{{ employment.name }}</mat-option>
                                }
                            </mat-select>
                            @if (form.get("employment")?.invalid && !form.get("employment")?.untouched) {
                                <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                    <mat-icon svgIcon="error"></mat-icon>
                                </span>
                            }
                            </mat-form-field>
                            @if (formDisabled) {
                                <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                            }
                        </div>
                        <div class="relative overflow-visible">
                            <mat-form-field appearance="outline" class="w-full">
                                <mat-label>Опыт работы</mat-label>
                            <mat-select [formControl]="form.controls['experience']">
                                @for (experience of experiences; track $index) {
                                    <mat-option [value]="experience.value">{{ experience.name }}</mat-option>
                                }
                            </mat-select>
                            @if (form.get("experience")?.invalid && !form.get("experience")?.untouched) {
                                <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                    <mat-icon svgIcon="error"></mat-icon>
                                </span>
                            }
                            </mat-form-field>
                            @if (formDisabled) {
                                <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                            }
                        </div>
                        <div class="relative overflow-visible">
                            <mat-form-field appearance="outline" class="w-full">
                                <mat-label>Режим работы</mat-label>
                            <mat-select [formControl]="form.controls['schedule']">
                                @for (schedule of schedules; track $index) {
                                    <mat-option [value]="schedule.value">{{ schedule.name }}</mat-option>
                                }
                            </mat-select>
                            @if (form.get("schedule")?.invalid && !form.get("schedule")?.untouched) {
                                <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                    <mat-icon svgIcon="error"></mat-icon>
                                </span>
                            }
                            </mat-form-field>
                            @if (formDisabled) {
                                <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                            }
                        </div>
                    </div>
                </div>
            </mat-tab>

            <mat-tab label="Согласование">
                <div class="flex flex-col gap-4 py-4 overflow-y-auto pr-2">
                    <div class="relative overflow-visible">
                        <h2 class="text-2xl font-semibold mb-2">Цепочка согласования</h2>
                        <div [formGroup]="form">
                            <div [formArrayName]="'approval_stages'">
                                @for (interviewer of approvalStages.controls; track interviewer) {
                                    <div class="mb-2" [formGroupName]="$index">
                                        <div class="flex justify-between items-center">
                                            <h3 class="h-[40px]">{{ interviewer.get('stage')?.value }}-й этап согласования</h3>
                                            @if ($index > 0) {
                                                <span class="text-red-600 cursor-pointer" (click)="removeInterviewer($index)">Удалить</span>
                                            }
                                        </div>
                                        <div class="flex flex-col">
                                            <mat-form-field appearance="outline" class="w-full">
                                                <mat-label>Выберите сотрудника</mat-label>
                                                <mat-select #userSelect formControlName="space_user_id" (selectionChange)="onOptionChange($event, $index)">
                                                    @for (item of getAvailableUsers($index); track item) {
                                                        <mat-option [value]="item.id">{{ item.last_name }} {{ item.first_name }}</mat-option>
                                                    }
                                                    @if (interviewer.get('space_user_id')?.invalid && !interviewer.get('space_user_id')?.untouched) {
                                                        <span class="absolute right-0 top-1 w-12 h-12 flex justify-center items-center">
                                                            <mat-icon svgIcon="error"></mat-icon>
                                                        </span>
                                                    }
                                                </mat-select>
                                            </mat-form-field>
                                            @if (interviewer.get('space_user_id')?.invalid && !interviewer.get('space_user_id')?.untouched) {
                                                <span class="flex">
                                                    <p class="text-[var(--error)] text-[13px]">{{ errorText }}</p>
                                                </span>
                                            }
                                        </div>
                                    </div>
                                }
                                @if (status === ModelsVRStatus.VRStatusCreated || status === ModelsVRStatus.VRStatusDraft) {
                                    <button class="w-[243px]" mat-flat-button class="btn-primary" (click)="addInterviewer()">
                                        Добавить этап согласования
                                    </button>
                                }
                            </div>
                        </div>
                        @if (status !== ModelsVRStatus.VRStatusCreated && status !== ModelsVRStatus.VRStatusDraft) {
                            <div class="absolute -top-4 left-0 right-0 bottom-0 rounded-lg bg-white/40 pointer-events-auto z-10" aria-hidden="true"></div>
                        }
                    </div>

                    <!-- @if (approvalsList.length && status !== ModelsVRStatus.VRStatusCreated) {
                        <h2 class="text-3xl mb-4">История согласования</h2>
                        <div class="overflow-x-auto rounded-xl border border-gray-200">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="text-left py-3 px-4 font-medium text-[var(--text-main)]">Сотрудник</th>
                                        <th class="text-left py-3 px-4 font-medium text-[var(--text-main)]">Статус</th>
                                        <th class="text-left py-3 px-4 font-medium text-[var(--text-main)] max-w-[400px] w-[400px]">Комментарий</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (task of approvalsList; track task.id) {
                                        <tr class="border-t border-gray-200 hover:bg-gray-50/50">
                                            <td class="py-3 px-4 text-[var(--text-main)]">{{ task.assignee_user_name ?? '—' }}</td>
                                            <td class="py-3 px-4 text-[var(--text-alter)]">{{ getApprovalStateDisplayName(task.state) }}</td>
                                            <td class="py-3 px-4 align-top">
                                                <span class="block max-w-[280px] break-words text-[var(--text-alter)]">{{ task.comment?.trim() ?? '—' }}</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    } -->

                    @if (status === ModelsVRStatus.VRStatusInApproval) {
                        <h2 class="text-3xl mb-4">Комментарий к заявке</h2>
                        <label class="text-base font-medium mb-2">Написать комментарий</label>
                        <textarea
                            matInput
                            [formControl]="form.controls['description']"
                            class="flex-1 min-h-[120px] border border-gray-300 rounded p-4 resize-none w-full"
                        ></textarea>
                    }
                </div>
            </mat-tab>
        </mat-tab-group>
    </form>
} @else {
    <div class="w-full min-h-[50vh] flex items-center justify-center">
        <app-loader></app-loader>
    </div>
}
